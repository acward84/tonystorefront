<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Simple Shopify Product</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; padding: 24px; max-width: 720px; margin: 0 auto; }
    img { max-width: 100%; height: auto; border-radius: 12px; }
    .card { border: 1px solid #e5e5e5; border-radius: 16px; padding: 16px; }
    .row { display: flex; gap: 12px; align-items: center; margin-top: 12px; }
    button { padding: 10px 16px; border: 0; border-radius: 10px; cursor: pointer; }
    #buyButton { background: black; color: white; }
    #buyButton:disabled { opacity: 0.6; cursor: not-allowed; }
    .price { font-weight: 600; font-size: 18px; margin: 8px 0; }
    .note { color: #666; font-size: 14px; }
  </style>
</head>
<body>
  <div class="card">
    <h1>My Product Test v10</h1>
    <img src="https://test.testtheedgefun.com/cdn/shop/files/general-clothes-minimal-1.jpg?v=1750331796&width=1500" width="400" alt="Product image" />
    <p class="price">€25.00</p>
    <div class="row">
      <label for="qty">Qty</label>
      <input id="qty" type="number" min="1" value="1" style="width: 80px; padding: 8px; border: 1px solid #ddd; border-radius: 8px;" />
      <button id="buyButton">Add to Cart → Checkout</button>
    </div>
    <p class="note">You’ll be redirected to secure checkout.</p>
    <p id="message" class="note" role="status"></p>
  </div>

  <script>
    // ── Configure these values ─────────────────────────────────────────────
    const SHOPIFY_DOMAIN   = "p10m9x-zb.myshopify.com"; // Storefront API host
    const API_VERSION      = "2025-01";                     // Storefront API version
    const STOREFRONT_TOKEN = "75f2e1e0b42c89c0bdac20258ce17cb5"; // public Storefront token
    const VARIANT_GID      = "gid://shopify/ProductVariant/54773228339545"; // product variant GID
    const CHECKOUT_HOST    = "checkout.testtheedgefun.com";     // your checkout subdomain
    const PARENT_DOMAIN    = "testtheedgefun.com";          // cookie parent domain (covers www + checkout)
    // ──────────────────────────────────────────────────────────────────────

    const API_URL = `https://${SHOPIFY_DOMAIN}/api/${API_VERSION}/graphql.json`;
    const buyBtn  = document.getElementById("buyButton");
    const qtyInput= document.getElementById("qty");
    const msg     = document.getElementById("message");

    // --- Cookie helpers ---
    function setCookie(name, value, {
      domain = PARENT_DOMAIN,
      path = '/',
      maxAge = 31536000,      // 1 year (Safari ITP may shorten)
      sameSite = 'Lax',       // good for same-site subdomain navigation
      secure = true
    } = {}) {
      const parts = [
        `${encodeURIComponent(name)}=${encodeURIComponent(value)}`,
        `Path=${path}`,
        `Domain=${domain}`,
        `Max-Age=${maxAge}`,
        `SameSite=${sameSite}`
      ];
      if (secure) parts.push('Secure'); // required on HTTPS
      document.cookie = parts.join('; ');
    }

    function getCookie(name) {
      const encoded = encodeURIComponent(name);
      return document.cookie
        .split('; ')
        .map(v => v.split('='))
        .find(([k]) => k === encoded)?.[1] || undefined;
    }

    function uuid() {
      // RFC4122-ish, good enough for a visitor/session id
      return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,c =>
        (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
      );
    }

    // Storefront Cart API: create a cart to get checkoutUrl
    const CART_CREATE = `
      mutation CreateCart($lines: [CartLineInput!]!, $buyerIdentity: CartBuyerIdentityInput) {
        cartCreate(input: { lines: $lines, buyerIdentity: $buyerIdentity }) {
          cart {
            id
            checkoutUrl
          }
          userErrors { field message }
        }
      }
    `;

    async function createCartAndCheckout(variantId, quantity) {
      const variables = {
        lines: [{ merchandiseId: variantId, quantity: Math.max(1, parseInt(quantity || "1", 10)) }],
        buyerIdentity: { countryCode: "AT" } // optional; influences pricing/Markets
      };

      const res = await fetch(API_URL, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-Shopify-Storefront-Access-Token": STOREFRONT_TOKEN
        },
        body: JSON.stringify({ query: CART_CREATE, variables })
      });

      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const json = await res.json();
      const ue = json?.data?.cartCreate?.userErrors;
      if (ue && ue.length) throw new Error(ue.map(e => e.message).join(', '));

      const checkoutUrl = json?.data?.cartCreate?.cart?.checkoutUrl;
      console.log("YP My checkouturl is " +  checkoutUrl);
      if (!checkoutUrl) throw new Error("No checkoutUrl returned");
      let updated = checkoutUrl.replace("https://checkout.", "https://test.");
      return checkoutUrl;
    }

    function preferCheckoutHost(urlString, preferredHost) {
      // If Shopify returns myshopify.com, swap to your connected checkout host
      try {
        const u = new URL(urlString);
        console.log("[checkout] API returned host →", u.hostname);

        // If domain setup is complete, API may already return preferredHost.
        if (u.hostname === preferredHost) return u.toString();

        // Temporary fallback: rewrite only if it's still myshopify.com
        if (u.hostname.endsWith(".myshopify.com")) {
          u.hostname = preferredHost;
          console.log("[checkout] Rewrote host →", u.hostname);
        }
        return u.toString();
      } catch (e) {
        console.warn("Bad checkout URL, cannot rewrite:", urlString, e);
        return urlString;
      }
    }

    async function beginCheckout() {
      buyBtn.disabled = true;
      msg.textContent = "Preparing checkout…";
      try {
        // 1) Ensure a visitor id cookie exists on the parent domain
        const existing = getCookie('edgee_follow');
        const id = existing || uuid();
        if (!existing) {
          setCookie('edgee_follow', id);
          console.log('[Cookie] edgee_follow set on', PARENT_DOMAIN, '=', id);
        } else {
          console.log('[Cookie] edgee_follow already present =', id);
        }

        // 2) Create cart → get checkoutUrl
        const rawUrl = await createCartAndCheckout(VARIANT_GID, qtyInput.value);

        // 3) Optional readback before leaving
        console.log('[Cookie] readback on current host:', getCookie('edgee_follow'));

        // 4) Prefer your checkout subdomain
        const finalUrl = preferCheckoutHost(rawUrl, CHECKOUT_HOST);

        // 5) Redirect to Shopify Checkout
        window.location.href = finalUrl;
      } catch (e) {
        console.error(e);
        alert("Could not start checkout: " + e.message);
        msg.textContent = "There was a problem starting checkout.";
      } finally {
        buyBtn.disabled = false;
      }
    }

    document.getElementById("buyButton").addEventListener("click", beginCheckout);
  </script>
</body>
</html>
